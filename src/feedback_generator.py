# src/feedback_generator.py
"""
(ì „ë¬¸ê°€ ë²„ì „)
ì ìˆ˜ ë¶„ì„ ê²°ê³¼(score_data)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ ì œê³µë  ì‹¬ì¸µ ë¶„ì„ í”¼ë“œë°±ì„ ìƒì„±í•©ë‹ˆë‹¤.
ê° í•­ëª©ì— ëŒ€í•œ ì§„ë‹¨, ì›ì¸ ë¶„ì„, ê°œì„  ë°©ì•ˆì„ í¬í•¨í•œ ì „ë¬¸ì ì¸ ì½”ë©˜íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
"""
from typing import Dict, Any, Tuple, List

# ==============================================================================
# à¹€à¸Šà¸´à¸‡ FEEDBACK MESSAGE TEMPLATES (ì „ë¬¸ê°€ ë²„ì „)
# ==============================================================================
# ê° í…œí”Œë¦¿ì—ëŠ” {value} í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ì œ ì¸¡ì •ê°’ì„ ë™ì ìœ¼ë¡œ ì‚½ì…í•©ë‹ˆë‹¤.
FEEDBACK_MESSAGES = {
    # --- ì„íŒ©íŠ¸ í‰ê°€ í•­ëª© ---
    "hitting_foot_part": {
        "name": "íƒ€ê²© ë¶€ìœ„",
        "good": "ì´ìƒì ì¸ íƒ€ê²© ë¶€ìœ„ ({value}): í‚¥ì˜ ëª©ì ì— ë§ëŠ” ì •í™•í•œ ë¶€ìœ„(ì¸ìŠ¤í…/ì¸ì‚¬ì´ë“œ)ë¡œ ê³µì„ ê°€ê²©í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ìŠˆíŒ…ì˜ ì •í™•ë„ì™€ íŒŒì›Œë¥¼ ê·¹ëŒ€í™”í•˜ëŠ” ê°€ì¥ ê¸°ë³¸ì ì¸ ì¡°ê±´ì´ë©°, ì˜ë„í•œ ëŒ€ë¡œ ê³µì„ ì»¨íŠ¸ë¡¤í•˜ê³  ìˆë‹¤ëŠ” ì¦ê±°ì…ë‹ˆë‹¤.",
        "bad": "ë¶€ì •í™•í•œ íƒ€ê²© ë¶€ìœ„ ({value}): ê³µì´ ë°œì˜ ì˜ë„ì¹˜ ì•Šì€ ë¶€ìœ„ì— ë§ì•˜ìŠµë‹ˆë‹¤. ì´ëŠ” í‚¥ì˜ ë°©í–¥ì´ í”ë“¤ë¦¬ê±°ë‚˜ íŒŒì›Œê°€ ì†ì‹¤ë˜ëŠ” ì§ì ‘ì ì¸ ì›ì¸ì´ ë©ë‹ˆë‹¤. ê¾¸ì¤€í•œ ì—°ìŠµì„ í†µí•´ ë°œë“± ë˜ëŠ” ì¸ì‚¬ì´ë“œì˜ ì •í™•í•œ ë©´ì— ê³µì„ ë§ì¶”ëŠ” ê°ê°ì„ ìµíˆëŠ” ê²ƒì´ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤.",
    },
    "ball_contact_point": {
        "name": "ê³µ íƒ€ê²© ì§€ì ",
        "good": "ì •í™•í•œ ê³µ íƒ€ê²© ì§€ì  ({value}): ê³µì˜ ì¤‘ì‹¬(Center) í˜¹ì€ ì¤‘ì‹¬-í•˜ë‹¨(Bottom)ì„ ì •í™•íˆ ê°€ê²©í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ìš´ë™ ì—ë„ˆì§€ë¥¼ ê³µì— ì˜¨ì „íˆ ì „ë‹¬í•˜ì—¬ ê°•ë ¥í•œ ì§ì„  ë˜ëŠ” ìƒìŠ¹ ê¶¤ì ì„ ë§Œë“œëŠ” í•µì‹¬ ê¸°ìˆ ì…ë‹ˆë‹¤.",
        "bad": "ì•„ì‰¬ìš´ ê³µ íƒ€ê²© ì§€ì  ({value}): ê³µì˜ ì¤‘ì‹¬ì—ì„œ ë²—ì–´ë‚œ ê³³ì„ íƒ€ê²©í•˜ì—¬ í˜ì´ ë¶„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ê³µì˜ ìƒë‹¨ì„ ë§ì¶”ë©´ ë•…ë³¼ì´ ë˜ê³ , ë„ˆë¬´ í•˜ë‹¨ì„ ë§ì¶”ë©´ í˜ì—†ì´ ëœ° ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª©í‘œë¡œ í•˜ëŠ” ê¶¤ì ì— ë”°ë¼ ê³µì˜ ì–´ëŠ ë¶€ë¶„ì„ ì°°ì§€ ëª…í™•íˆ ì¸ì§€í•˜ëŠ” í›ˆë ¨ì´ í•„ìš”í•©ë‹ˆë‹¤.",
    },
    "support_foot_ball_distance": {
        "name": "ë””ë”¤ë°œê³¼ ê³µì˜ ê±°ë¦¬",
        "good": "ì´ìƒì ì¸ ë””ë”¤ë°œ ê±°ë¦¬ ({value}): ê³µ ì˜†ì— ìµœì ì˜ ê°„ê²©ìœ¼ë¡œ ë””ë”¤ë°œì„ ìœ„ì¹˜ì‹œì¼°ìŠµë‹ˆë‹¤. ì´ëŠ” ìƒì²´ì˜ ê· í˜•ì„ ì•ˆì •ì‹œí‚¤ê³ , í‚¥ì„ í•˜ëŠ” ë‹¤ë¦¬ê°€ ììœ ë¡­ê²Œ ìµœëŒ€ ìŠ¤ìœ™ì„ í•  ìˆ˜ ìˆëŠ” ê³µê°„ì„ í™•ë³´í•˜ì—¬ í‚¥ì˜ íŒŒì›Œì™€ ì•ˆì •ì„±ì„ ëª¨ë‘ ì¡ëŠ” êµê³¼ì„œì ì¸ ìì„¸ì…ë‹ˆë‹¤.",
        "bad": "ë¶ˆì•ˆì •í•œ ë””ë”¤ë°œ ê±°ë¦¬ ({value}): ë””ë”¤ë°œì´ ê³µê³¼ ë„ˆë¬´ ê°€ê¹ê±°ë‚˜ ë©€ì—ˆìŠµë‹ˆë‹¤. ë„ˆë¬´ ê°€ê¹Œìš°ë©´ ìŠ¤ìœ™ ê³µê°„ì´ ë¶€ì¡±í•´ ê°•ë ¥í•œ í‚¥ì´ ì–´ë µê³ , ë„ˆë¬´ ë©€ë©´ ëª¸ì˜ ì¤‘ì‹¬ì´ ë¬´ë„ˆì ¸ ì •í™•ë„ì™€ íŒŒì›Œê°€ ëª¨ë‘ ë–¨ì–´ì§‘ë‹ˆë‹¤. ìì‹ ì—ê²Œ ê°€ì¥ í¸ì•ˆí•˜ê³  ê°•ë ¥í•œ í‚¥ì´ ë‚˜ì˜¤ëŠ” ë””ë”¤ë°œ ìœ„ì¹˜ë¥¼ ë°˜ë³µ í›ˆë ¨ì„ í†µí•´ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.",
    },
    "ball_initial_speed": {
        "name": "ê³µì˜ ì´ˆê¸° ì†ë„",
        "good": "ì••ë„ì ì¸ ë³¼ ìŠ¤í”¼ë“œ ({value}): ë§¤ìš° ë¹ ë¥¸ ì´ˆê¸° ì†ë„ë¥¼ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ê°•ë ¥í•œ ìŠ¤ìœ™ê³¼ ì •í™•í•œ ì„íŒ©íŠ¸ê°€ ê²°í•©ëœ ê²°ê³¼ë¡œ, ìƒëŒ€ ê³¨í‚¤í¼ê°€ ë°˜ì‘í•˜ê¸° ì–´ë ¤ìš´ ìœ„í˜‘ì ì¸ ìŠˆíŒ… ëŠ¥ë ¥ì˜ ì¦ê±°ì…ë‹ˆë‹¤.",
        "bad": "ì•„ì‰¬ìš´ ë³¼ ìŠ¤í”¼ë“œ ({value}): ê³µì˜ ì´ˆê¸° ì†ë„ë¥¼ ë” ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì£¼ë¡œ ìŠ¤ìœ™ ì†ë„ê°€ ëŠë¦¬ê±°ë‚˜, ì„íŒ©íŠ¸ ì‹œ í˜ ì „ë‹¬ì´ íš¨ìœ¨ì ì´ì§€ ëª»í•  ë•Œ ë°œìƒí•©ë‹ˆë‹¤. ë°±ìŠ¤ìœ™ í¬ê¸°ë¥¼ í‚¤ìš°ê³ , ê³ ê´€ì ˆ íšŒì „ì„ ì‚¬ìš©í•˜ì—¬ ìŠ¤ìœ™ ì†ë„ë¥¼ ë†’ì´ëŠ” í›ˆë ¨ì´ íš¨ê³¼ì ì…ë‹ˆë‹¤.",
    },
    "impact_angle_comparison": {
        "name": "ì„íŒ©íŠ¸ ìì„¸ ì •í™•ë„",
        "good": "í”„ë¡œ ìˆ˜ì¤€ì˜ ì„íŒ©íŠ¸ ìì„¸ (ìœ ì‚¬ë„ ì ìˆ˜: {value}): í”„ë¡œ ì„ ìˆ˜ì™€ ê±°ì˜ í¡ì‚¬í•œ ì„íŒ©íŠ¸ ìì„¸ì…ë‹ˆë‹¤. ì´ëŠ” ì‹ ì²´ì˜ ê° ê´€ì ˆ(ê³ ê´€ì ˆ, ë¬´ë¦, ë°œëª©)ì´ ì´ìƒì ì¸ ê°ë„ë¡œ í˜‘ì‘í•˜ë©° ìš´ë™ ì‚¬ìŠ¬(Kinetic Chain)ì„ í†µí•´ í˜ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì „ë‹¬í•˜ê³  ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.",
        "bad": " ê°œì„ ì´ í•„ìš”í•œ ì„íŒ©íŠ¸ ìì„¸ (ìœ ì‚¬ë„ ì ìˆ˜: {value}): ì„íŒ©íŠ¸ ìˆœê°„ì˜ ì‹ ì²´ ê°ë„ê°€ í”„ë¡œ ì„ ìˆ˜ì™€ ì°¨ì´ë¥¼ ë³´ì…ë‹ˆë‹¤. íŠ¹íˆ ë¬´ë¦ì´ë‚˜ ìƒì²´ ê°ë„ê°€ ë¶€ì ì ˆí•˜ë©´, ìƒì„±ëœ í˜ì´ ì—‰ëš±í•œ ê³³ìœ¼ë¡œ ìƒˆì–´ ë‚˜ê°€ê±°ë‚˜ ë¶€ìƒì˜ ìœ„í—˜ì„ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í”„ë¡œ ì„ ìˆ˜ì˜ ìì„¸ë¥¼ ì°¸ê³ í•˜ì—¬ êµì •í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.",
    },
    # --- ë°±ìŠ¤ìœ™ í‰ê°€ í•­ëª© ---
    "max_foot_swing_speed": {
        "name": "ìµœëŒ€ ìŠ¤ìœ™ ì†ë„",
        "good": "í­ë°œì ì¸ ìŠ¤ìœ™ ì†ë„ ({value}): í”„ë¡œ ì„ ìˆ˜ê¸‰ì˜ ë§¤ìš° ë¹ ë¥¸ ìµœëŒ€ ìŠ¤ìœ™ ì†ë„ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. ì´ëŠ” ê°•ë ¥í•œ í‚¥ íŒŒì›Œì˜ í•µì‹¬ ì›ì²œìœ¼ë¡œ, ì˜ í›ˆë ¨ëœ í•˜ì²´ì™€ ì½”ì–´ ê·¼ë ¥ì„ ì¦ëª…í•©ë‹ˆë‹¤.",
        "bad": "ì•„ì‰¬ìš´ ìŠ¤ìœ™ ì†ë„ ({value}): ìŠ¤ìœ™ì˜ ìµœëŒ€ ì†ë„ë¥¼ ë” ëŒì–´ì˜¬ë¦´ í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤. ë°±ìŠ¤ìœ™ì˜ í¬ê¸°ë¥¼ í‚¤ìš°ê³ , í—ˆë¦¬ì™€ ê³ ê´€ì ˆì˜ íšŒì „ë ¥ì„ ì ê·¹ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ì±„ì°ì²˜ëŸ¼ íœ˜ë‘ë¥´ëŠ” ëŠë‚Œìœ¼ë¡œ ìŠ¤ìœ™ ìŠ¤í”¼ë“œë¥¼ ë†’ì´ëŠ” ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.",
    },
    # --- ìŠ¤ìœ™ì•ˆì •ì„± í‰ê°€í•­ëª© ---
    "kick_foot_kinematics_change": {
        "name": "ìŠ¤ìœ™ ê°€ì† ì•ˆì •ì„±",
        "good": "ì•ˆì •ì ì¸ ê°€ì† ({value}): ì„íŒ©íŠ¸ ì§ì „ê¹Œì§€ ë¶ˆí•„ìš”í•œ ê°€ì†/ê°ì† ì—†ì´, ë°±ìŠ¤ìœ™ì˜ í˜ì„ ëê¹Œì§€ ìœ ì§€í•˜ëŠ” ë§¤ìš° ì•ˆì •ì ì¸ ìŠ¤ìœ™ì…ë‹ˆë‹¤.",
        "bad": " ë¶ˆì•ˆì •í•œ ê°€ì† ({value}): ì„íŒ©íŠ¸ ì§ì „ ìŠ¤ìœ™ ì†ë„ê°€ ê¸‰ê²©í•˜ê²Œ ë³€í–ˆìŠµë‹ˆë‹¤. í˜ì„ ì£¼ë ¤ë‹¤ ìì„¸ê°€ ííŠ¸ëŸ¬ì§€ê±°ë‚˜, ê³µì„ ë§ì¶”ê¸° ìœ„í•´ ì–µì§€ë¡œ ì†ë„ë¥¼ ì¡°ì ˆí•˜ëŠ” ë“± ë¶ˆì•ˆì •í•œ ìŠ¤ìœ™ì…ë‹ˆë‹¤.",
    },
    "backswing_knee_angle_size": {
        "name": "ë°±ìŠ¤ìœ™ ì‹œ ë¬´ë¦ ê°ë„",
        "good": "ìµœì ì˜ ë°±ìŠ¤ìœ™ ë¬´ë¦ ê°ë„ ({value}): ë°±ìŠ¤ìœ™ ì‹œ ë¬´ë¦ì„ ì¶©ë¶„íˆ ê¹Šê²Œ ì ‘ì–´, ë§ˆì¹˜ í™œì‹œìœ„ë¥¼ ë‹¹ê¸°ë“¯ ê°•ë ¥í•œ íƒ„ì„± ì—ë„ˆì§€ë¥¼ ë‹¤ë¦¬ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” í­ë°œì ì¸ ìŠ¤ìœ™ ì†ë„ë¡œ ì´ì–´ì§€ëŠ” ì¤‘ìš”í•œ ì¤€ë¹„ ë™ì‘ì…ë‹ˆë‹¤.",
        "bad": "ë¶€ì¡±í•œ ë°±ìŠ¤ìœ™ ë¬´ë¦ ê°ë„ ({value}): ë°±ìŠ¤ìœ™ ì‹œ ë¬´ë¦ì´ ì¶©ë¶„íˆ ì ‘íˆì§€ ì•Šì•„, í‚¥ì— ì‚¬ìš©ë  ì—ë„ˆì§€ë¥¼ ìµœëŒ€ë¡œ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë” ê³¼ê°í•˜ê³  í° ë°±ìŠ¤ìœ™ ë™ì‘ìœ¼ë¡œ ë¬´ë¦ì„ ë” ì ‘ì–´ì£¼ë©´ ìŠ¤ìœ™ íŒŒì›Œê°€ ê·¹ì ìœ¼ë¡œ í–¥ìƒë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    },
    "support_foot_stability": {
        "name": "ë””ë”¤ë°œ ì•ˆì •ì„±",
        "good": "ë°˜ì„ ê°™ì€ ë””ë”¤ë°œ ì•ˆì •ì„± (í‰ê·  í”ë“¤ë¦¼: {value}): í‚¥ ëª¨ì…˜ ë‚´ë‚´ ë””ë”¤ë°œì´ í”ë“¤ë¦¼ ì—†ì´ ì§€ë©´ì— ë‹¨ë‹¨íˆ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë””ë”¤ë°œì€ ëª¨ë“  í˜ì„ ì§€íƒ±í•˜ëŠ” 'ì¶•'ì´ë¯€ë¡œ, ì´ ì•ˆì •ì„±ì€ ì§€ë©´ ë°˜ë°œë ¥ì„ ì˜¨ì „íˆ íŒŒì›Œë¡œ ì „í™˜ì‹œí‚¤ëŠ” ê°€ì¥ ì¤‘ìš”í•œ ìš”ì†Œì…ë‹ˆë‹¤.",
        "bad": " unsteady: ë¶ˆì•ˆì •í•œ ë””ë”¤ë°œ (í‰ê·  í”ë“¤ë¦¼: {value}): í‚¥ì„ í•˜ëŠ” ë™ì•ˆ ë””ë”¤ë°œì´ í”ë“¤ë¦¬ëŠ” ëª¨ìŠµì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” ì½”ì–´ ë°¸ëŸ°ìŠ¤ê°€ ë¬´ë„ˆì¡Œê±°ë‚˜, ë””ë”¤ë°œì„ ë”›ëŠ” í˜ì´ ë¶€ì¡±í•˜ë‹¤ëŠ” ì‹ í˜¸ì…ë‹ˆë‹¤. íŒŒì›Œ ì†ì‹¤ì˜ ì£¼ëœ ì›ì¸ì´ ë˜ë¯€ë¡œ, í•œ ë°œ ì„œê¸° ë“± ë°¸ëŸ°ìŠ¤ í›ˆë ¨ê³¼ ë””ë”¤ë°œì„ ë•…ì— 'ì‹¬ëŠ”ë‹¤'ëŠ” ëŠë‚Œìœ¼ë¡œ ë”›ëŠ” ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.",
    },
    "backswing_angle_comparison": {
        "name": "ë°±ìŠ¤ìœ™ ìì„¸ ì •í™•ë„",
        "good": " êµê³¼ì„œì ì¸ ë°±ìŠ¤ìœ™ ìì„¸ (ìœ ì‚¬ë„ ì ìˆ˜: {value}): í”„ë¡œ ì„ ìˆ˜ì™€ ë§¤ìš° ìœ ì‚¬í•œ ë°±ìŠ¤ìœ™ ìì„¸ì…ë‹ˆë‹¤. ë¶ˆí•„ìš”í•œ ë™ì‘ì´ ì—†ëŠ” ê°„ê²°í•˜ê³  íš¨ìœ¨ì ì¸ ìì„¸ë¡œ, ë‹¤ìŒ ë™ì‘ì¸ ì„íŒ©íŠ¸ë¡œ í˜ì„ ì†ì‹¤ ì—†ì´ ì—°ê²°í•˜ê¸°ì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.",
        "bad": "ğŸ¦µ ê°œì„ ì´ í•„ìš”í•œ ë°±ìŠ¤ìœ™ ìì„¸ (ìœ ì‚¬ë„ ì ìˆ˜: {value}): ë°±ìŠ¤ìœ™ ì‹œ ì‹ ì²´ ê°ë„ê°€ í”„ë¡œ ì„ ìˆ˜ì™€ ë‹¤ì†Œ ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ìƒì²´ê°€ ë„ˆë¬´ ì¼ì° ì—´ë¦¬ê±°ë‚˜ íŒ”ì˜ ìœ„ì¹˜ê°€ ë¶€ì ì ˆí•˜ë©´ ê· í˜•ì´ ë¬´ë„ˆì ¸ ìŠ¤ìœ™ì˜ íŒŒì›Œë‚˜ ì •í™•ë„ì— ë‚˜ìœ ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    },
}


# ==============================================================================
# à¹€à¸Šà¸´à¸‡ FEEDBACK GENERATION LOGIC
# ==============================================================================
def _get_overall_comment(total_score: float) -> str:
    """ì´ì ì— ë”°ë¼ ì „ë¬¸ì ì¸ ì´í‰ì„ ë°˜í™˜í•©ë‹ˆë‹¤."""
    if total_score >= 90:
        return "âš½ï¸ í”„ë¡œ ì„ ìˆ˜ ìˆ˜ì¤€ì˜ í‚¥ ë©”ì»¤ë‹ˆì¦˜ì…ë‹ˆë‹¤. ëª¨ë“  í‰ê°€ í•­ëª©ì—ì„œ ìµœìƒìœ„ê¶Œì˜ ê¸°ëŸ‰ì„ ë³´ì—¬ì£¼ì—ˆìœ¼ë©°, í˜ì˜ ìƒì„±, ì „ë‹¬, ì •í™•ì„± ë©´ì—ì„œ ê±°ì˜ ì™„ë²½ì— ê°€ê¹Œìš´ ëª¨ìŠµì„ ë³´ì…ë‹ˆë‹¤. í˜„ ìƒíƒœë¥¼ ìœ ì§€í•˜ë©° ì»¨ë””ì…˜ ê´€ë¦¬ì— ì§‘ì¤‘í•˜ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤."
    elif total_score >= 75:
        return "ğŸ‘ ë§¤ìš° ë›°ì–´ë‚œ í‚¥ì…ë‹ˆë‹¤. ì•ˆì •ì ì¸ ì‹ ì²´ ë°¸ëŸ°ìŠ¤ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°•ë ¥í•œ ìš´ë™ ì—ë„ˆì§€ë¥¼ ìƒì„±í•˜ê³ , ì´ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê³µì— ì „ë‹¬í•˜ëŠ” ëŠ¥ë ¥ì„ ê°–ì¶”ì—ˆìŠµë‹ˆë‹¤. ì¼ë¶€ ì‚¬ì†Œí•œ ë‹¨ì ë§Œ ë³´ì™„í•œë‹¤ë©´ ê²½ê¸°ì—ì„œ ê²°ì •ì ì¸ ì°¨ì´ë¥¼ ë§Œë“¤ì–´ë‚¼ ìˆ˜ ìˆëŠ” ê°•ë ¥í•œ ë¬´ê¸°ê°€ ë  ê²ƒì…ë‹ˆë‹¤."
    elif total_score >= 60:
        return "ğŸ™‚ í›Œë¥­í•œ ì ì¬ë ¥ì„ ê°€ì§„ í‚¥ì…ë‹ˆë‹¤. ì „ë°˜ì ìœ¼ë¡œ ì¢‹ì€ ê¸°ë³¸ê¸°ë¥¼ ê°–ì¶”ê³  ìˆìœ¼ë‚˜, íŠ¹ì • êµ¬ê°„ì—ì„œ í˜ì˜ ì†ì‹¤ì´ë‚˜ ìì„¸ì˜ ë¶ˆì•ˆì •ì„±ì´ ê´€ì°°ë©ë‹ˆë‹¤. ì œì‹œëœ ì•½ì ì„ ì§‘ì¤‘ì ìœ¼ë¡œ ê°œì„ í•œë‹¤ë©´ ê²½ê¸°ë ¥ì„ í•œ ë‹¨ê³„ ìœ„ë¡œ ëŒì–´ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    elif total_score >= 40:
        return "ğŸƒ ê°œì„ í•´ì•¼ í•  ë¶€ë¶„ì´ ëª…í™•íˆ ë³´ì´ëŠ” í‚¥ì…ë‹ˆë‹¤. ì˜ ìˆ˜í–‰ëœ ë¶€ë¶„ë„ ìˆì§€ë§Œ, í‚¥ì˜ íŒŒì›Œì™€ ì •í™•ì„±ì— í° ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” í•µì‹¬ì ì¸ ë¶€ë¶„ì—ì„œ ì•„ì‰¬ì›€ì´ ë‚¨ìŠµë‹ˆë‹¤. í”¼ë“œë°±ì„ í†µí•´ ìì‹ ì˜ ì•½ì ì„ ëª…í™•íˆ ì¸ì§€í•˜ê³ , ëª©ì ì„ ê°€ì§„ í›ˆë ¨ì„ í†µí•´ ê°œì„ í•´ ë‚˜ê°€ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤."
    else:
        return "ğŸ‘Ÿ ê¸°ë³¸ê¸°ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ë‹¤ì§ˆ í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ í‚¥ ë©”ì»¤ë‹ˆì¦˜ì€ í˜ì˜ ì „ë‹¬ íš¨ìœ¨ì´ ë‚®ê³  ìì„¸ê°€ ë¶ˆì•ˆì •í•˜ì—¬, ì ì¬ë ¥ì„ ì¶©ë¶„íˆ ë°œíœ˜í•˜ì§€ ëª»í•˜ê³  ìˆìŠµë‹ˆë‹¤. ê´œì°®ìŠµë‹ˆë‹¤. ëª¨ë“  ì „ë¬¸ê°€ëŠ” ì´ˆë³´ì ì‹œì ˆì´ ìˆì—ˆìŠµë‹ˆë‹¤. í”¼ë“œë°±ì„ ë°”íƒ•ìœ¼ë¡œ ê¸°ë³¸ ë™ì‘ë¶€í„° ë°˜ë³µí•˜ì—¬ ëª¸ì— ìµíˆëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤."


def _find_key_strengths_and_weaknesses(
    score_data: Dict[str, Any],
) -> Tuple[List[str], List[str]]:
    """ê°€ì¥ ì ìˆ˜ê°€ ë†’ì€ í•­ëª©(ê°•ì )ê³¼ ë‚®ì€ í•­ëª©(ì•½ì )ì„ ì°¾ì•„ êµ¬ì²´ì ì¸ ë°ì´í„°ì™€ í•¨ê»˜ í”¼ë“œë°±ì„ ìƒì„±í•©ë‹ˆë‹¤."""
    metrics = []
    for category_name, category_data in score_data["categories"].items():
        for key, details in category_data["details"].items():
            if isinstance(details.get("value"), str) and details.get(
                "value", ""
            ).startswith("N/A"):
                continue

            score_ratio = (
                details["score"] / details["max_score"]
                if details["max_score"] > 0
                else 0
            )
            metrics.append(
                {
                    "key": key,
                    "ratio": score_ratio,
                    "value": details.get("value", "N/A"),
                    "message_template": FEEDBACK_MESSAGES.get(key, {}),
                }
            )

    metrics.sort(key=lambda x: x["ratio"])

    weaknesses = []
    for metric in metrics[:2]:
        if metric["ratio"] < 0.6 and "bad" in metric["message_template"]:
            formatted_message = metric["message_template"]["bad"].format(
                value=metric["value"]
            )
            weaknesses.append(formatted_message)

    strengths = []
    for metric in reversed(metrics[-2:]):
        if metric["ratio"] >= 0.8 and "good" in metric["message_template"]:
            formatted_message = metric["message_template"]["good"].format(
                value=metric["value"]
            )
            strengths.append(formatted_message)

    return strengths, weaknesses


def _generate_phase_feedback(phase_name: str, phase_data: Dict[str, Any]) -> str:
    """ë°±ìŠ¤ìœ™/ì„íŒ©íŠ¸ ë‹¨ê³„ë³„ ì ìˆ˜ì™€ ì„¸ë¶€ í•­ëª©ì„ ì¢…í•©í•˜ì—¬ ìƒì„¸ í”¼ë“œë°±ì„ ìƒì„±í•©ë‹ˆë‹¤."""
    phase_score = phase_data.get("subtotal", 0)

    if phase_score >= 40:
        summary = f"ì „ë°˜ì ìœ¼ë¡œ ë§¤ìš° ì•ˆì •ì ì´ê³  ê°•ë ¥í•œ {phase_name} ë™ì‘ì„ ë³´ì—¬ì¤ë‹ˆë‹¤."
    elif phase_score >= 30:
        summary = f"ì¢‹ì€ {phase_name} ë™ì‘ì…ë‹ˆë‹¤. ë‹¤ë§Œ ëª‡ ê°€ì§€ ì„¸ë¶€ í•­ëª©ì„ ê°œì„ í•˜ë©´ ì™„ì„±ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    else:
        summary = f"{phase_name} ë™ì‘ì˜ íš¨ìœ¨ì„±ê³¼ ì•ˆì •ì„±ì„ ë†’ì´ê¸° ìœ„í•œ ì§‘ì¤‘ì ì¸ í›ˆë ¨ì´ í•„ìš”í•´ ë³´ì…ë‹ˆë‹¤."

    # ì„¸ë¶€ í•­ëª© ì¤‘ ê°€ì¥ ì ìˆ˜ê°€ ë‚®ì€ í•­ëª©ì„ ì°¾ì•„ ì¶”ê°€ ì½”ë©˜íŠ¸
    details = phase_data.get("details", {})
    if not details:
        return summary

    lowest_metric = min(
        details.items(),
        key=lambda item: (
            item[1]["score"] / item[1]["max_score"] if item[1]["max_score"] > 0 else 1
        ),
    )

    key, lowest_details = lowest_metric
    score_ratio = (
        lowest_details["score"] / lowest_details["max_score"]
        if lowest_details["max_score"] > 0
        else 1
    )

    if score_ratio < 0.6:
        metric_name = FEEDBACK_MESSAGES.get(key, {}).get("name", "ì´ í•­ëª©")
        summary += f" íŠ¹íˆ, '{metric_name}' ë¶€ë¶„ì„ ì¤‘ì ì ìœ¼ë¡œ ê°œì„ í•œë‹¤ë©´ í•´ë‹¹ ë‹¨ê³„ì˜ ì™„ì„±ë„ê°€ í¬ê²Œ í–¥ìƒë  ê²ƒì…ë‹ˆë‹¤."

    return summary


def generate_feedback(score_data: Dict[str, Any]) -> Dict[str, Any]:
    """
    ìµœì¢… ì ìˆ˜ ë°ì´í„°ë¥¼ ì…ë ¥ë°›ì•„ í”ŒëŸ¬í„° í™”ë©´ í˜•ì‹ì— ë§ëŠ”
    ì „ë¬¸ê°€ í”¼ë“œë°± ë”•ì…”ë„ˆë¦¬ë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    if not score_data or "total_score" not in score_data:
        return {"error": "ë¶„ì„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ í”¼ë“œë°±ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}

    total_score = score_data.get("total_score", 0)

    # 1. ì¢…í•© ì¹´ë“œ ë°ì´í„° ìƒì„±
    overall_comment = _get_overall_comment(total_score)
    strengths, weaknesses = _find_key_strengths_and_weaknesses(score_data)

    overall_card = {
        "ì´ì ": round(total_score),
        "ì´í‰": overall_comment,
        "í”¼ë“œë°±": {
            "ë§¤ìš° ì˜í•œì ": (
                strengths
                if strengths
                else [
                    "ì „ë°˜ì ìœ¼ë¡œ ê· í˜• ì¡íŒ ëª¨ìŠµì„ ë³´ì—¬ì£¼ì…¨ìŠµë‹ˆë‹¤. ì•½ì ì„ ë³´ì™„í•˜ëŠ” ë° ì§‘ì¤‘í•´ ë³´ì„¸ìš”!"
                ]
            ),
            "ì•„ì‰¬ìš´ ì ": (
                weaknesses
                if weaknesses
                else ["íŠ¹ë³„íˆ ì•„ì‰¬ìš´ ì  ì—†ì´ ëª¨ë“  ë©´ì—ì„œ í›Œë¥­í•œ í‚¥ì„ ë³´ì—¬ì£¼ì…¨ìŠµë‹ˆë‹¤!"]
            ),
        },
    }

    # 2. ë°±ìŠ¤ìœ™ ì¹´ë“œ ë°ì´í„° ìƒì„±
    backswing_eval = score_data["categories"]["backswing_evaluation"]
    backswing_score = backswing_eval.get("subtotal", 0)
    backswing_feedback = _generate_phase_feedback("ë°±ìŠ¤ìœ™", backswing_eval)

    backswing_card = {
        "ë°±ìŠ¤ìœ™ ì ìˆ˜": round(backswing_score),
        "ë°±ìŠ¤ìœ™ í”¼ë“œë°±": backswing_feedback,
    }

    # 3. ì„íŒ©íŠ¸ ì¹´ë“œ ë°ì´í„° ìƒì„±
    impact_eval = score_data["categories"]["impact_evaluation"]
    impact_score = impact_eval.get("subtotal", 0)
    impact_feedback = _generate_phase_feedback("ì„íŒ©íŠ¸", impact_eval)

    impact_card = {"ì„íŒ©íŠ¸ ì ìˆ˜": round(impact_score), "ì„íŒ©íŠ¸ í”¼ë“œë°±": impact_feedback}

    # ìµœì¢… ê²°ê³¼ë¬¼ ì¡°í•©
    final_feedback_package = {
        "ì¢…í•©": overall_card,
        "ë°±ìŠ¤ìœ™": backswing_card,
        "ì„íŒ©íŠ¸": impact_card,
    }

    return final_feedback_package
